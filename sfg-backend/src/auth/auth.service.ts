import { Injectable, UnauthorizedException, Logger } from '@nestjs/common';
import { SignupDto } from './dtos/signup.dto';
import { AuthPayload } from './entities/auth-payload.entity';
import { UserService } from 'src/user/user.service';
import { LoginDto } from './dtos/login.dto';
import { PasswordService } from 'src/user/password/password.service';
import { TokenService } from './token/token.service';
import { AuthPayloadDomain } from './entities/auth-payload.domain';
import { UserDomain } from 'src/user/user.domain';

@Injectable()
export class AuthService {
  private readonly logger = new Logger(AuthService.name);

  constructor(
    private readonly userService: UserService,
    private readonly passwordService: PasswordService,
    private readonly tokenService: TokenService,
  ) {}

  async signup({
    email,
    password,
    firstName,
    userName,
    lastName,
  }: SignupDto): Promise<AuthPayloadDomain> {
    try {
      this.logger.debug(`üöÄ Starting signup for email: ${email}`);

      const user = await this.userService.createUser({
        userInfo: { email },
        passwordInfo: { rawPassword: password },
        profileInfo: { firstName, lastName, userName },
      });

      this.logger.debug(`‚úÖ User created successfully: ${user.userId}`);

      const token = await this.tokenService.issueTokenForUser(
        user.userId,
        user.role,
      );

      this.logger.debug(`üé´ Token generated for user: ${user.userId}`);

      return {
        user,
        token: token.token,
      };
    } catch (error) {
      this.logger.error(`‚ùå Signup failed for email: ${email}`, error.stack);
      throw error;
    }
  }

  async login({
    userNameOrEmail,
    password,
  }: LoginDto): Promise<AuthPayloadDomain> {
    this.logger.debug(`üîç Attempting login for: ${userNameOrEmail}`);

    let user: UserDomain;

    try {
      this.logger.debug('üìß Trying email lookup...');
      user = await this.userService.getUser({ email: userNameOrEmail });
      this.logger.debug(
        `‚úÖ Found user by email: ${user.email} (ID: ${user.userId})`,
      );
    } catch (emailError) {
      this.logger.debug(`‚ö†Ô∏è Email lookup failed: ${emailError.message}`);

      try {
        this.logger.debug('üìß Trying username lookup...');
        user = await this.userService.getUserByProfile({
          userName: userNameOrEmail,
        });
        this.logger.debug(
          `‚úÖ Found user by username: ${userNameOrEmail} (ID: ${user.userId})`,
        );
      } catch (usernameError) {
        this.logger.debug(
          `‚ö†Ô∏è Username lookup failed: ${usernameError.message}`,
        );
        this.logger.debug(
          `‚ùå Both email and username lookup failed for: ${userNameOrEmail}`,
        );
        throw new UnauthorizedException('Invalid credentials.');
      }
    }

    this.logger.debug(`üîê Validating password for user: ${user.userId}`);

    const isValid = await this.passwordService.validatePassword({
      userId: user.userId,
      rawPassword: password,
    });

    if (!isValid) {
      this.logger.warn(`‚ùå Invalid password for user: ${user.userId}`);
      throw new UnauthorizedException('Invalid credentials.');
    }

    this.logger.debug(
      `‚úÖ Password validation successful for user: ${user.userId}`,
    );

    const token = await this.tokenService.issueTokenForUser(
      user.userId,
      user.role,
    );

    this.logger.debug(
      `üé´ Token generated successfully for user: ${user.userId}`,
    );

    return {
      user,
      token: token.token,
    };
  }
}
